<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Fly High</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hexo theme - Icarus">
<meta property="og:type" content="website">
<meta property="og:title" content="Fly High">
<meta property="og:url" content="http://shijianguang.github.io/index.html">
<meta property="og:site_name" content="Fly High">
<meta property="og:description" content="Hexo theme - Icarus">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fly High">
<meta name="twitter:description" content="Hexo theme - Icarus">
  
  
    <link rel="icon" href="favicon.png">
  
  <link href='//fonts.useso.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/css/images/logo.png)"></i><span class="site-title">Fly High</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/css/images/avatar.png"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://shijianguang.github.io"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/categories">Categories</a></td>
        
          <td><a class="main-nav-link" href="/tags">Tags</a></td>
        
          <td><a class="main-nav-link" href="/about">About</a></td>
        
        <td>
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://shijianguang.github.io"></form>
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/css/images/avatar.png">
      <h2 id="name">Jianguang Shi</h2>
      <h3 id="title">Backend Developer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
      <a id="follow" href="null">FOLLOW</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        4
        <span>posts</span>
      </div>
      <div class="article-info-block">
        4
        <span>tags</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="/#" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="/#" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/#" target="_blank" title="dribbble"><i class="fa fa-dribbble"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main">
      <article id="post-C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/28/C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰/">C++ å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2016/08/28/C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰/">
      <time datetime="2016-08-28T04:13:02.000Z" itemprop="datePublished">2016-08-28</time>
    </a>
  </div>


          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>å³å€¼å¼•ç”¨(Rvalue Reference)æ˜¯C++11æ ‡å‡†ä¸­å¼•å…¥çš„ç‰¹æ€§ï¼ŒåŸºäºå³å€¼å¼•ç”¨ï¼ŒC++11å®ç°äº†è½¬ç§»è¯­ä¹‰(Move Sementics)å’Œç²¾ç¡®ä¼ é€’(Perfect Forwarding)ã€‚è¿™å‡ ä¸ªç‰¹æ€§ä¹Ÿæ˜¯C++11ä¸­çš„é‡è¦çš„æ–°ç‰¹æ€§ï¼Œç”¨ä»¥æå‡C++è¯­è¨€çš„æ ¸å¿ƒæ€§èƒ½å’Œè®¡ç®—é€Ÿåº¦ã€‚ä¸»è¦ä½“ç°åœ¨ä¸€ä¸‹æ–¹é¢ï¼š</p>
<ol>
<li>ä»¥å³å€¼å¼•ç”¨ä¸ºåŸºç¡€çš„è½¬ç§»è¯­ä¹‰ï¼Œæ¶ˆé™¤äº†å¯¹è±¡äº¤äº’æ—¶ä¸å¿…è¦çš„å¯¹è±¡æ‹·è´ï¼ŒèŠ‚çœè¿ç®—å­˜å‚¨èµ„æºï¼Œæé«˜æ•ˆç‡ã€‚</li>
<li>ç²¾ç¡®ä¼ é€’èƒ½å¤Ÿä½¿å¼€å‘è€…æ›´ç®€æ´æ˜ç¡®çš„å®šä¹‰æ³›å‹å‡½æ•°ã€‚</li>
</ol>
<h2 id="ä¼ ç»ŸC++ä¸­çš„å¯¹è±¡æ„é€ ã€æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ">ä¼ ç»ŸC++ä¸­çš„å¯¹è±¡æ„é€ ã€æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œ</h2><p>åœ¨æ¢è®¨å³å€¼å¼•ç”¨çš„é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹C++11ä¹‹å‰çš„ä»£ç ä¸­ï¼Œå¯¹è±¡çš„ä¼ é€’æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚åœ¨C++11ä¹‹å‰ï¼Œå¯¹è±¡çš„ä¼ é€’ä¸»è¦è·Ÿæ„é€ å‡½æ•°ï¼Œæ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼æ„é€ å‡½æ•°ã€‚å…·ä½“å‚è§å®ä¾‹ç¨‹åºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">class</span> MyString &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">char</span>* _data;</span><br><span class="line">    <span class="keyword">size_t</span> _len;</span><br><span class="line">    <span class="keyword">void</span> _init_data(<span class="keyword">const</span> <span class="keyword">char</span> *s) &#123;</span><br><span class="line">        _data = <span class="keyword">new</span> <span class="keyword">char</span>[_len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">memcpy</span>(_data, s, _len);</span><br><span class="line">        _data[_len] = <span class="string">'\0'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    MyString() &#123;</span><br><span class="line">        _data = <span class="literal">NULL</span>;</span><br><span class="line">        _len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MyString(<span class="keyword">const</span> <span class="keyword">char</span>* p) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            _len = <span class="number">0</span>;</span><br><span class="line">            _data = <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _len = <span class="built_in">strlen</span>(p);</span><br><span class="line">            _init_data(p);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Constructor is called! source: "</span> &lt;&lt; (_data == <span class="literal">NULL</span> ? <span class="string">"NULL"</span> : _data) &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MyString(<span class="keyword">const</span> MyString&amp; str) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str._len == <span class="number">0</span> &amp;&amp; str._data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            _len = <span class="number">0</span>;</span><br><span class="line">            _data = <span class="literal">NULL</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _len = str._len;</span><br><span class="line">            _init_data(str._data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Copy Constructor is called! source: "</span> &lt;&lt; (_data == <span class="literal">NULL</span> ? <span class="string">"NULL"</span> : _data)</span><br><span class="line">                &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MyString&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> MyString&amp; str) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;str) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str._len == <span class="number">0</span> &amp;&amp; str._data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                _len = <span class="number">0</span>;</span><br><span class="line">                _data = <span class="literal">NULL</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _len = str._len;</span><br><span class="line">                _init_data(str._data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Copy Assignment is called! source: "</span> &lt;&lt; (_data == <span class="literal">NULL</span> ? <span class="string">"NULL"</span> : _data)</span><br><span class="line">                &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">char</span> * <span class="title">get_data</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~MyString() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_data != <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">delete</span> _data;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Deconstructor is called"</span> &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">MyString <span class="title">get_new_string</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello World 5"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"##########Begin Rvalue Test##########"</span> &lt;&lt; endl;</span><br><span class="line">    MyString a;</span><br><span class="line">    MyString b = <span class="string">"Hello World 1"</span>;</span><br><span class="line">    a = MyString(<span class="string">"Hello world 2"</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MyString&gt; vec;</span><br><span class="line">    vec.reserve(<span class="number">128</span>);</span><br><span class="line">    vec.push_back(<span class="string">"Hello World 3"</span>);</span><br><span class="line">    MyString c = get_new_string();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; c.get_data() &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"##########End Rvalue Test##########"</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ä¾‹ç¨‹åºçš„è¾“å‡ºæ˜¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">##########Begin Rvalue Test##########</span></span><br><span class="line">Constructor is called! source: Hello World <span class="number">1</span></span><br><span class="line">Constructor is called! source: Hello world <span class="number">2</span></span><br><span class="line">Copy Assignment is called! source: Hello world <span class="number">2</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Constructor is called! source: Hello World <span class="number">3</span></span><br><span class="line">Copy Constructor is called! source: Hello World <span class="number">3</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Constructor is called! source: Hello World <span class="number">5</span></span><br><span class="line">Hello World <span class="number">5</span></span><br><span class="line"><span class="preprocessor">##########End Rvalue Test##########</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br></pre></td></tr></table></figure>
<p>ä»å®ä¾‹ä¸­å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç»“è®ºï¼š</p>
<ol>
<li>è™½ç„¶å…³äºbçš„è¡¨è¾¾å¼æ˜¯ <code>b = &quot;Hello World 1&quot;</code>ï¼Œä½†å› ä¸ºæ˜¯å‡ºç°åœ¨å˜é‡å®šä¹‰çš„é˜¶æ®µï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªåˆå§‹åŒ–æ“ä½œï¼Œè°ƒç”¨äº†å‚æ•°æ˜¯const char * çš„æ„é€ å‡½æ•°ã€‚</li>
<li>ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶å¯¹è±¡MyString(â€œHello World 2â€)èµ‹å€¼ç»™å˜é‡aï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸´æ—¶å˜é‡éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°ï¼Œç„¶åé€šè¿‡æ‹·è´æ„é€ å‡½æ•°å®Œæˆå¯¹açš„èµ‹å€¼ï¼Œæœ€åé€šè¿‡ææ„å‡½æ•°é‡Šæ”¾æ‰è¿™ä¸ªä¸´æ—¶å¯¹è±¡ã€‚</li>
<li>å‘vectorä¸­æ”¾å…¥ä¸€ä¸ªâ€Hello World 3â€œå¯¹è±¡ï¼Œé¦–å…ˆé€šè¿‡const char *æ„é€ å‡½æ•°æ„é€ ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç„¶ååœ¨push_backå‡½æ•°å†…éƒ¨é€šè¿‡æ‹·è´æ„é€ å‡½æ•°ï¼Œå°†è¿™ä¸ªä¸´æ—¶å¯¹è±¡æ‹·è´åˆ°vectorå†…éƒ¨çš„å­˜å‚¨ç©ºé—´ä¸­ï¼Œæœ€åé€šè¿‡ææ„å‡½æ•°é‡Šæ”¾ä¸´æ—¶å¯¹è±¡ã€‚</li>
<li>get_new_string()å‡½æ•°è¿”å›ä¸€ä¸ªMyStringçš„å¯¹è±¡ï¼Œè¿™é‡Œæ²¡æœ‰äº§ç”Ÿä¸´æ—¶å¯¹è±¡ï¼Œæ‰§è¡Œæ‹·è´æ„é€ çš„åŸå› æ˜¯gccç¼–è¯‘å™¨ä½¿ç”¨äº†è¿”å›å€¼ä¼˜åŒ–ï¼Œé¿å…äº†å¯¹äºçš„è°ƒç”¨ã€‚</li>
</ol>
<h2 id="å·¦å€¼å’Œå³å€¼">å·¦å€¼å’Œå³å€¼</h2><p>C++( åŒ…æ‹¬ C) ä¸­æ‰€æœ‰çš„è¡¨è¾¾å¼å’Œå˜é‡è¦ä¹ˆæ˜¯å·¦å€¼ï¼Œè¦ä¹ˆæ˜¯å³å€¼ã€‚é€šä¿—çš„å·¦å€¼çš„å®šä¹‰å°±æ˜¯éä¸´æ—¶å¯¹è±¡ï¼Œé‚£äº›å¯ä»¥åœ¨å¤šæ¡è¯­å¥ä¸­ä½¿ç”¨çš„å¯¹è±¡ã€‚æ‰€æœ‰çš„å˜é‡éƒ½æ»¡è¶³è¿™ä¸ªå®šä¹‰ï¼Œåœ¨å¤šæ¡ä»£ç ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼Œéƒ½æ˜¯å·¦å€¼ã€‚å³å€¼æ˜¯æŒ‡ä¸´æ—¶çš„å¯¹è±¡ï¼Œå®ƒä»¬åªåœ¨å½“å‰çš„è¯­å¥ä¸­æœ‰æ•ˆã€‚æ¯”å¦‚ä¸Šè¿°å®ä¾‹ä»£ç ä¸­ï¼Œå˜é‡a, b, vec, céƒ½æ˜¯å·¦å€¼ï¼Œè€Œâ€Hello World1â€, MyString(â€œHellow World 2â€) å’Œ â€œHello World 5â€éƒ½æ˜¯å³å€¼ã€‚</p>
<p>åœ¨C++ä¸­ï¼Œå·¦å€¼çš„å¼•ç”¨ä½¿ç”¨ç¬¦å· <code>&amp;</code> è¡¨ç¤ºï¼Œå³å€¼çš„å¼•ç”¨é€šè¿‡ <code>&amp;&amp;</code>è¡¨ç¤ºï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> &amp; b = a;  <span class="comment">//å·¦å€¼å¼•ç”¨</span></span><br><span class="line"><span class="keyword">int</span> &amp;&amp; c = <span class="number">1</span>; <span class="comment">//å³å€¼å¼•ç”¨</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ç¨‹åºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_function</span><span class="params">(<span class="keyword">int</span> &amp; i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Left Value: "</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_function</span><span class="params">(<span class="keyword">int</span> &amp;&amp; i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Right Value: "</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">right_value_2_left_value</span><span class="params">(<span class="keyword">int</span> &amp;&amp; i)</span> </span>&#123;</span><br><span class="line">    process_function(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    process_function(i);</span><br><span class="line">    process_function(<span class="number">2</span>);</span><br><span class="line">    right_value_2_left_value(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿è¡Œç»“æœ</span></span><br><span class="line">Left Value: <span class="number">1</span></span><br><span class="line">Right Value: <span class="number">2</span></span><br><span class="line">Left Value: <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œ<strong>i</strong> è¢«å½“åšå·¦å€¼è¿›è¡Œä¼ é€’ï¼Œ<strong>2</strong> è¢«å½“åšå³å€¼è¿›è¡Œä¼ é€’ï¼Œ<strong>3</strong> è™½ç„¶æ˜¯ä¸€ä¸ªå³å€¼ï¼Œä½†è¿›å…¥<strong>right_value_2_left_value</strong>è¿™ä¸ªå‡½æ•°ä¸­åï¼Œè¢«è½¬æ¢æˆäº†å·¦å€¼ã€‚</p>
<h2 id="è½¬ç§»è¯­ä¹‰">è½¬ç§»è¯­ä¹‰</h2><p>å³å€¼å¼•ç”¨æ˜¯ç”¨æ¥æ”¯æŒè½¬ç§»è¯­ä¹‰çš„ã€‚è½¬ç§»è¯­ä¹‰å¯ä»¥å°†èµ„æº ( å †ï¼Œç³»ç»Ÿå¯¹è±¡ç­‰ ) ä»ä¸€ä¸ªå¯¹è±¡è½¬ç§»åˆ°å¦ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘ä¸å¿…è¦çš„ä¸´æ—¶å¯¹è±¡çš„åˆ›å»ºã€æ‹·è´ä»¥åŠé”€æ¯ï¼Œèƒ½å¤Ÿå¤§å¹…åº¦æé«˜ C++ åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ä¸´æ—¶å¯¹è±¡çš„ç»´æŠ¤ ( åˆ›å»ºå’Œé”€æ¯ ) å¯¹æ€§èƒ½æœ‰ä¸¥é‡å½±å“ã€‚<br>è½¬ç§»è¯­ä¹‰æ˜¯å’Œæ‹·è´è¯­ä¹‰ç›¸å¯¹çš„ï¼Œå¯ä»¥ç±»æ¯”æ–‡ä»¶çš„å‰ªåˆ‡ä¸æ‹·è´ï¼Œå½“æˆ‘ä»¬å°†æ–‡ä»¶ä»ä¸€ä¸ªç›®å½•æ‹·è´åˆ°å¦ä¸€ä¸ªç›®å½•æ—¶ï¼Œé€Ÿåº¦æ¯”å‰ªåˆ‡æ…¢å¾ˆå¤šã€‚<br>é€šè¿‡è½¬ç§»è¯­ä¹‰ï¼Œä¸´æ—¶å¯¹è±¡ä¸­çš„èµ„æºèƒ½å¤Ÿè½¬ç§»å…¶å®ƒçš„å¯¹è±¡é‡Œã€‚<br>åœ¨ç°æœ‰çš„ C++ æœºåˆ¶ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦å®ç°è½¬ç§»è¯­ä¹‰ï¼Œéœ€è¦å®šä¹‰è½¬ç§»æ„é€ å‡½æ•°ï¼Œè¿˜å¯ä»¥å®šä¹‰è½¬ç§»èµ‹å€¼æ“ä½œç¬¦ã€‚å¯¹äºå³å€¼çš„æ‹·è´å’Œèµ‹å€¼ä¼šè°ƒç”¨è½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»èµ‹å€¼æ“ä½œç¬¦ã€‚å¦‚æœè½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»æ‹·è´æ“ä½œç¬¦æ²¡æœ‰å®šä¹‰ï¼Œé‚£ä¹ˆå°±éµå¾ªç°æœ‰çš„æœºåˆ¶ï¼Œæ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼æ“ä½œç¬¦ä¼šè¢«è°ƒç”¨ã€‚<br>æ™®é€šçš„å‡½æ•°å’Œæ“ä½œç¬¦ä¹Ÿå¯ä»¥åˆ©ç”¨å³å€¼å¼•ç”¨æ“ä½œç¬¦å®ç°è½¬ç§»è¯­ä¹‰ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬åœ¨<strong>MyString</strong>ä¸­åŠ å…¥è½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»å¤åˆ¶å‡½æ•°ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è½¬ç§»æ„é€ å‡½æ•°</span></span><br><span class="line">MyString(MyString&amp;&amp; str) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Move Constructor is called! source: "</span> &lt;&lt; str._data</span><br><span class="line">            &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    _len = str._len;</span><br><span class="line">    _data = str._data;</span><br><span class="line">    str._len = <span class="number">0</span>;</span><br><span class="line">    str._data = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è½¬ç§»å¤åˆ¶å‡½æ•°</span></span><br><span class="line">MyString&amp; <span class="keyword">operator</span>=(MyString&amp;&amp; str) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Move Assignment is called! source: "</span> &lt;&lt; str._data</span><br><span class="line">            &lt;&lt; <span class="built_in">std</span>::endl;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> != &amp;str) &#123;</span><br><span class="line">        _len = str._len;</span><br><span class="line">        _data = str._data;</span><br><span class="line">        str._len = <span class="number">0</span>;</span><br><span class="line">        str._data = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ å®Œæˆåï¼Œé‡æ–°è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œå¯ä»¥å¾—åˆ°æ–°çš„è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">##########Begin Rvalue Test##########</span></span><br><span class="line">Constructor is called! source: Hello World <span class="number">1</span></span><br><span class="line">Constructor is called! source: Hello world <span class="number">2</span></span><br><span class="line">Move Assignment is called! source: Hello world <span class="number">2</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Constructor is called! source: Hello World <span class="number">3</span></span><br><span class="line">Move Constructor is called! source: Hello World <span class="number">3</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Constructor is called! source: Hello World <span class="number">5</span></span><br><span class="line">Hello World <span class="number">5</span></span><br><span class="line"><span class="preprocessor">##########End Rvalue Test##########</span></span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br><span class="line">Deconstructor is called</span><br></pre></td></tr></table></figure>
<p>ä»ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨åˆ°äº†ä¸´æ—¶å˜é‡ï¼Œç¬¬ä¸€å¤„æ˜¯èµ‹å€¼è¯­å¥ <strong>a = MyString(â€œHello world 2â€);</strong>ï¼Œåœ¨å®ç°äº†è½¬ç§»å¤åˆ¶å‡½æ•°åï¼Œè¿™æ¬¡èµ‹å€¼æ“ä½œå·²ç»æ”¹ä¸ºè°ƒç”¨è½¬ç§»å¤åˆ¶å‡½æ•°ã€‚ç¬¬äºŒå¤„æ˜¯å‡½æ•°ä¼ é€’å‚æ•°<strong>vec.push_back(â€œHello World 3â€);</strong>ï¼Œè¿™é‡Œçš„æ“ä½œå·²ç»æ”¹ä¸ºè°ƒç”¨è½¬ç§»æ„é€ å‡½æ•°ã€‚</p>
<p>è¿™æ ·çš„ç»“æœåŸºæœ¬è¯´æ˜äº†è½¬ç§»è¯­ä¹‰çš„ä½œç”¨ï¼Œåœ¨æ²¡æœ‰è½¬ç§»è¯­ä¹‰çš„æ—¶å€™ï¼Œç¨‹åºåœ¨<strong>a = MyString(â€œHello world 2â€);</strong> å’Œ <strong>vec.push_back(â€œHello World 3â€);</strong>è¿™ä¸¤å¤„å¯¹ä¸¤ä¸ªä¸´æ—¶å˜é‡å®è¡Œäº†ä¸¤æ¬¡æ— ç”¨çš„å¤åˆ¶æ“ä½œï¼Œå¹¶ä¸”å†…å­˜ä¸­æ¯ä¸ªä¸´æ—¶å˜é‡æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ªæ˜¯ä¸´æ—¶å˜é‡æœ¬èº«ï¼Œå¦ä¸€ä¸ªè¢«æ‹·è´åˆ°å¯¹åº”çš„å·¦å€¼ä¸­ï¼ŒåŒæ—¶åœ¨ææ„çš„æ—¶å€™ï¼Œä¹Ÿè¦æ‰§è¡Œä¸¤æ¬¡æ— ç”¨çš„å†…å­˜é‡Šæ”¾æ“ä½œæ¥é‡Šæ”¾ä¸´æ—¶å˜é‡çš„å†…å­˜ã€‚è€Œå®šä¹‰äº†è½¬ç§»è¯­ä¹‰ä¹‹åï¼Œè¿™ä¸‰ä¸ªæ–¹é¢ä¸å¿…è¦æ€§èƒ½æ¶ˆè€—éƒ½å·²ç»è¢«é¿å…äº†ã€‚é¦–å…ˆï¼Œè½¬ç§»æ“ä½œé€šè¿‡å†…éƒ¨èµ„æºçš„äº¤æ¢å®ç°å¯¹å·¦å€¼çš„æ›´æ–°ï¼Œé¿å…äº†å†…å­˜æ‹·è´ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†ä¸´æ—¶å˜é‡ä¸­ä¿å­˜å¤šä½™çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨ææ„è¿‡ç¨‹ä¸­ï¼Œç”±äºè½¬ç§»æ“ä½œå°†ç©ºæŒ‡é’ˆè½¬ç§»ç»™ä¸´æ—¶å˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦é¢å¤–çš„å†…å­˜é‡Šæ”¾æ“ä½œã€‚æ‰€ä»¥è½¬ç§»è¯­ä¹‰å³èŠ‚çœäº†æ—¶é—´ï¼Œæœ‰èŠ‚çœäº†ç©ºé—´</p>
<p>å®ç°è½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»èµ‹å€¼å‡½æ•°æ˜¯è¦æ³¨æ„ä¸€ä¸‹æ–¹é¢ï¼š</p>
<ol>
<li>å‚æ•°å¿…é¡»æ˜¯å³å€¼å¼•ç”¨ &amp;&amp;</li>
<li>å‚æ•°ä¸èƒ½æ˜¯å¸¸é‡ï¼Œå› ä¸ºè½¬ç§»æ“ä½œä¸­éœ€è¦ä¿®æ”¹å‚æ•°</li>
<li>å‚æ•°ä¸­èµ„æºéœ€è¦å¦¥å–„å¤„ç†ï¼Œé¿å…å‚æ•°è¢«ææ„åï¼Œå¯¼è‡´è½¬ç§»åˆ°çš„æ–°å¯¹è±¡ä¸å¯ç”¨</li>
</ol>
<p>æœ‰äº†å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡å’Œå®ç°ç±»æ—¶ï¼Œå¯¹äºéœ€è¦åŠ¨æ€ç”³è¯·å¤§é‡èµ„æºçš„ç±»ï¼Œåº”è¯¥è®¾è®¡è½¬ç§»æ„é€ å‡½æ•°å’Œè½¬ç§»èµ‹å€¼å‡½æ•°ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„æ•ˆç‡ã€‚</p>
<h2 id="std::move">std::move</h2><p>ç”±ä¸Šæ–‡å¯ä»¥çœ‹å‡ºï¼Œåœ¨C++ç¨‹åºä¸­ï¼Œè™½ç„¶è½¬ç§»æ“ä½œå¯ä»¥èŠ‚çœç©ºé—´å’Œæ—¶é—´ï¼Œä½†æ˜¯åªæœ‰å³å€¼æ‰èƒ½è§¦å‘è½¬ç§»æ“ä½œã€‚è€ŒC++ä¸­æ‰€æœ‰çš„å‘½åå¯¹è±¡éƒ½æ˜¯å·¦å€¼ï¼Œé‚£å¦‚æœå½“æˆ‘ä»¬æ˜ç¡®çŸ¥é“ä¸€ä¸ªå·¦å€¼å·²ç»ä¸ä¼šå†è¢«ä½¿ç”¨ï¼Œå¸Œæœ›å†…éƒ¨èµ„æºå¯ä»¥äº¤æ¢ç»™åˆ«çš„å·¦å€¼æ—¶å¦‚ä½•ä½¿ç”¨è½¬ç§»è¯­ä¹‰å‘¢ï¼Ÿè¿™æ˜¯æ—¶å€™éœ€è¦ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„std::move()æ“ä½œï¼Œè¿™ä¸ªæ“ä½œå°†ä¸€ä¸ªå·¦å€¼å˜æˆä¸€ä¸ªå³å€¼ï¼Œè¿›è€Œä½¿ç”¨è½¬ç§»æ“ä½œã€‚å…·ä½“ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_function</span><span class="params">(<span class="keyword">int</span> &amp; i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Left Value: "</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_function</span><span class="params">(<span class="keyword">int</span> &amp;&amp; i)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"Right Value: "</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> ** argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">2</span>;</span><br><span class="line">    process_function(i);</span><br><span class="line">    process_function(<span class="built_in">std</span>::move(i));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿è¡Œç»“æœ</span></span><br><span class="line">Left Value: <span class="number">2</span></span><br><span class="line">Right Value: <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h2 id="ç²¾ç¡®ä¼ é€’">ç²¾ç¡®ä¼ é€’</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://shijianguang.github.io/2016/08/28/C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰/" data-id="cisg8uycq000hdqs6xoummowf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-C/">C/C++</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/27/C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦/">C++ wchar_t è¡¨ç¤ºä¸­æ–‡å­—ç¬¦</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2016/08/27/C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦/">
      <time datetime="2016-08-27T12:32:36.000Z" itemprop="datePublished">2016-08-27</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Work/">Work</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>æœ€è¿‘åœ¨å·¥ä½œä¸­ä½¿ç”¨äº†ä¸€ä¸ªå¼€æºçš„ï¼ŒåŸºäºCè¯­è¨€çš„<a href="https://linux.thai.net/~thep/datrie/datrie.html" target="_blank" rel="external">Double Array Trieæ•°æ®ç»“æ„</a>æ¥æ„é€ keywordså­—å…¸ã€‚è¿™ä¸ªå¼€æºç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œå°†uint32é‡å®šä¹‰ä¸ºå†…éƒ¨çš„AlphaCharç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚è€Œè¿™æ ·çš„è¡¨ç¤ºæ–¹æ³•ï¼Œè®©è‡ªå·±åœ¨codingè¿‡ç¨‹ä¸­éœ€è¦è¿›ä¸€æ­¥äº†è§£C/C++ä¸­å¦‚ä½•è¡¨ç¤ºå’Œå­˜å‚¨ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ã€‚</p>
<h2 id="ç¼–ç ç›¸å…³çŸ¥è¯†">ç¼–ç ç›¸å…³çŸ¥è¯†</h2><p>æœ€æ—©çš„å­—ç¬¦ç¼–ç æ˜¯ASCIIç¼–ç ï¼Œä½¿ç”¨7ä¸ªbitè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œä¸€å…±èƒ½è¡¨ç¤º128ä¸ªå­—ç¬¦ã€‚è¿™å¯¹äºè‹±æ–‡å†…å®¹æ¥è¯´å·²ç»è¶³å¤Ÿäº†ï¼Œä½†æ— æ³•ç»“æœå¤šå›½è¯­è¨€çš„é—®é¢˜ï¼Œæ¯”å¦‚æ— æ³•è¡¨ç¤ºä¸­æ–‡ã€‚è€Œä¸ºäº†ç»Ÿä¸€å­—ç¬¦ç¼–ç çš„é—®é¢˜ï¼ŒUnicodeç¼–ç é€æ¸æˆä¸ºäº†ä¸€ç§ç°è¡Œçš„æ ‡å‡†ï¼Œå®ƒèƒ½å¤Ÿç¼–ç 100å¤šä¸‡ä¸­å­—ç¬¦ï¼Œæ¯ä¸€ä¸ªå­—ç¬¦éƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªUnicodeå€¼ä¸ä¹‹å¯¹åº”ã€‚<br>Unicodeè™½ç„¶ä¸ºå¤šå›½è¯­è¨€çš„å­—ç¬¦éƒ½å®šä¹‰äº†ç»Ÿä¸€çš„ç¼–ç ï¼Œä½†å¹¶æ²¡æœ‰å®šä¹‰å¦‚ä½•åœ¨è®¡ç®—æœºä¸­è¡¨ç¤ºè¿™ç§ç¼–ç ã€‚è¿™é‡Œä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚Unicodeä½¿ç”¨å¤šä¸ªè‡ªå·±è¿›è¡Œç¼–ç ï¼Œé‚£ä¹ˆè®¡ç®—æœºå¦‚ä½•çŸ¥é“å½“å‰è¿™ä¸ªå­—èŠ‚æ˜¯è¦è¡¨ç¤ºä¸€ä¸ªASCIIå­—ç¬¦ï¼Œè¿˜æ˜¯è¦è¡¨ç¤ºä¸€ä¸ªUnicodeå­—ç¬¦ä¸­çš„ä¸€ä¸ªå­—èŠ‚ã€‚è€Œè¿™é‡Œå°±å¼•å‡ºäº†å¤§å®¶å¹³æ—¶å¸¸è§UTF-8, UTF-16, UTF-32è¿™äº›æ¦‚å¿µã€‚å®ƒä»¬å’ŒUnicodeæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿç®€å•æ¥è¯´: <strong>UTF-8, UTF-16, UTF-32éƒ½æ˜¯Unicodeçš„ä¸€ç§å…·ä½“å®ç°ã€‚Unicodeå®šä¹‰äº†æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„Unicodeå€¼ï¼Œè€Œè¿™å‡ ç§å®ç°å®šäº†å¦‚ä½•åœ¨è®¡ç®—æœºä¸­è¡¨ç¤ºè¿™ä¸ªå€¼ã€‚è¿™å…¶ä¸­UTF-8æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„å®ç°æ–¹æ³•ã€‚ä»–æ˜¯ä¸€ç§å˜é•¿ç¼–ç ï¼Œç”¨1åˆ°4ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ã€‚å…·ä½“å†…å®¹å¯ä»¥å‚è§<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html" target="_blank" rel="external">è¿™ç¯‡åšå®¢</a></strong></p>
<h2 id="wchar_t_è¡¨ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦">wchar_t è¡¨ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦</h2><p>åœ¨Javaä¸­ï¼Œå†…å­˜ä¸­çš„charå®é™…ä¸Šä¸º2byteï¼Œé»˜è®¤é‡‡ç”¨Unicodeçš„æ–¹å¼å­˜å‚¨å­—ç¬¦ï¼Œæ‰€ä»¥åœ¨Javaä¸­ï¼Œcharå‹å˜é‡æ˜¯å¯ä»¥è¡¨ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦çš„ã€‚è€Œåœ¨C/C++ä¸­ï¼Œcharå‹å˜é‡æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œæ— æ³•è¡¨ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦ï¼Œæ¯”å¦‚char * str = â€œåˆ†å¸ƒå¼ç³»ç»Ÿâ€ï¼Œå½“ä½¿ç”¨strlen(str)æ¥è®¡ç®—é•¿åº¦æ˜¯ï¼Œåœ¨æˆ‘çš„Linuxæœºå™¨ä¸‹é•¿åº¦æ˜¯15è€Œä¸æ˜¯5ã€‚é‚£å¦‚ä½•è¡¨ç¤ºä¸€ä¸ªä¸­æ–‡å­—ç¬¦å‘¢ï¼Ÿä¸€ç§å¯è¡Œçš„åŠæ³•æ˜¯ä½¿ç”¨wchar_tæ¥ä»£æ›¿char.</p>
<p>wchar_tç±»å‹å ç”¨çš„å­—èŠ‚æ•°ä¸æ“ä½œç³»ç»Ÿæœ‰å…³ï¼Œåœ¨Linuxä¸­ï¼Œwchar_tå ç”¨å››ä¸ªå­—èŠ‚ã€‚åœ¨å·¥ä½œä¸­ï¼Œå°†åŸå§‹çš„char*å­—ç¬¦ä¸²è½¬æ¢ä¸ºwchat_t*å­—ç¬¦ä¸²ï¼Œç„¶åè¿­ä»£è¿™ä¸ªwchat_t*å­—ç¬¦ä¸²ï¼Œå°±å¯ä»¥é¡ºåˆ©çš„ä½¿ç”¨å‰æ–‡æåˆ°çš„DAtrieæ¥è¿›è¡ŒåŸºäºå­—å…¸çš„å…³é”®è¯æŠ½å–ã€‚</p>
<p>Cè¯­è¨€ä¸­æä¾›äº†å››ä¸ªåº“å‡½æ•°ç”¨äºchar*å’Œwchar_t*çš„äº’è½¬ï¼Œå…·ä½“å®ä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å°†ä¸€ä¸ªchar* å­—ç¬¦ä¸²srcè½¬æ¢ä¸ºwchar_t* å­—ç¬¦ä¸² dst, lenè¡¨ç¤ºwchar_t* dstä¸­çš„æœ‰å¤šå°‘ä¸ªwchar_tçš„å¯ç”¨ç©ºé—´</span></span><br><span class="line"><span class="comment">//ä¾èµ–ä¸€ä¸ªå…¨å±€çš„çŠ¶æ€å˜é‡ï¼Œçº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">size_t</span> mbstowcs( <span class="keyword">wchar_t</span>* dst, <span class="keyword">const</span> <span class="keyword">char</span>* src, <span class="built_in">std</span>::<span class="keyword">size_t</span> len);</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;clocale&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::setlocale(LC_ALL, <span class="string">"en_US.utf8"</span>);</span><br><span class="line">    <span class="built_in">std</span>::wcout.imbue(<span class="built_in">std</span>::locale(<span class="string">"en_US.utf8"</span>));</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mbstr = <span class="string">u8"z\u00df\u6c34\U0001f34c"</span>; <span class="comment">// or u8"zÃŸæ°´ğŸŒ"</span></span><br><span class="line">                        <span class="comment">// or "\x7a\xc3\x9f\xe6\xb0\xb4\xf0\x9f\x8d\x8c";</span></span><br><span class="line">    <span class="keyword">wchar_t</span> wstr[<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">std</span>::mbstowcs(wstr, mbstr, <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"wide string: "</span> &lt;&lt; wstr &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¸€ä¸ªwchar_t* å­—ç¬¦ä¸²srcè½¬æ¢æˆchar* å­—ç¬¦ä¸²dstï¼Œ lenè¡¨ç¤ºchar* dstä¸­æœ‰å¤šå°‘ä¸ªcharçš„å¯ç”¨ç©ºé—´</span></span><br><span class="line"><span class="comment">//ä¾èµ–ä¸€ä¸ªå…¨å±€çš„çŠ¶æ€å˜é‡ï¼Œçº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">size_t</span> wcstombs( <span class="keyword">char</span>* dst, <span class="keyword">const</span> <span class="keyword">wchar_t</span>* src, <span class="built_in">std</span>::<span class="keyword">size_t</span> len);</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;clocale&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::setlocale(LC_ALL, <span class="string">"en_US.utf8"</span>);</span><br><span class="line">    <span class="comment">// UTF-8 narrow multibyte encoding</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">wchar_t</span>* wstr = <span class="string">L"z\u00df\u6c34\U0001d10b"</span>; <span class="comment">// or L"zÃŸæ°´ğ„‹"</span></span><br><span class="line">    <span class="keyword">char</span> mbstr[<span class="number">11</span>];</span><br><span class="line">    <span class="built_in">std</span>::wcstombs(mbstr, wstr, <span class="number">11</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"multibyte string: "</span> &lt;&lt; mbstr &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¸€ä¸ªchar* å­—ç¬¦ä¸²srcè½¬æ¢ä¸ºwchar_t* å­—ç¬¦ä¸² dst, lenè¡¨ç¤ºwchar_t* dstä¸­çš„æœ‰å¤šå°‘ä¸ªwchar_tçš„å¯ç”¨ç©ºé—´, psè¡¨ç¤ºè½¬æ¢çŠ¶æ€å˜é‡</span></span><br><span class="line"><span class="comment">//ä¸ä¾èµ–å…¨å±€çš„çŠ¶æ€å˜é‡ï¼Œçº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">size_t</span> mbsrtowcs( <span class="keyword">wchar_t</span>* dst, <span class="keyword">const</span> <span class="keyword">char</span>** src, <span class="built_in">std</span>::<span class="keyword">size_t</span> len, <span class="built_in">std</span>::<span class="keyword">mbstate_t</span>* ps );</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;clocale&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cwchar&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_as_wide</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* mbstr)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">mbstate_t</span> state = <span class="built_in">std</span>::<span class="keyword">mbstate_t</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">1</span> + <span class="built_in">std</span>::mbsrtowcs(<span class="literal">NULL</span>, &amp;mbstr, <span class="number">0</span>, &amp;state);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">wchar_t</span>&gt; wstr(len);</span><br><span class="line">    <span class="built_in">std</span>::mbsrtowcs(&amp;wstr[<span class="number">0</span>], &amp;mbstr, wstr.size(), &amp;state);</span><br><span class="line">    <span class="built_in">std</span>::wcout &lt;&lt; <span class="string">"Wide string: "</span> &lt;&lt; &amp;wstr[<span class="number">0</span>] &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">               &lt;&lt; <span class="string">"The length, including '\\0': "</span> &lt;&lt; wstr.size() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::setlocale(LC_ALL, <span class="string">"en_US.utf8"</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mbstr = <span class="string">u8"z\u00df\u6c34\U0001f34c"</span>; <span class="comment">// or u8"zÃŸæ°´ğŸŒ"</span></span><br><span class="line">    print_as_wide(mbstr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¸€ä¸ªwchar_t* å­—ç¬¦ä¸²srcè½¬æ¢ä¸ºchar* å­—ç¬¦ä¸² dst, lenè¡¨ç¤ºwchar_t* dstä¸­çš„æœ‰å¤šå°‘ä¸ªwchar_tçš„å¯ç”¨ç©ºé—´, psè¡¨ç¤ºè½¬æ¢çŠ¶æ€å˜é‡</span></span><br><span class="line"><span class="comment">//ä¸ä¾èµ–å…¨å±€çš„çŠ¶æ€å˜é‡ï¼Œçº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">size_t</span> wcsrtombs( <span class="keyword">char</span>* dst, <span class="keyword">const</span> <span class="keyword">wchar_t</span>** src, <span class="built_in">std</span>::<span class="keyword">size_t</span> len, <span class="built_in">std</span>::<span class="keyword">mbstate_t</span>* ps );</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;clocale&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">&lt;cwchar&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_wide</span><span class="params">(<span class="keyword">const</span> wchar_t* wstr)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">mbstate_t</span> state = <span class="built_in">std</span>::<span class="keyword">mbstate_t</span>();</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">1</span> + <span class="built_in">std</span>::wcsrtombs(<span class="literal">nullptr</span>, &amp;wstr, <span class="number">0</span>, &amp;state);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt; mbstr(len);</span><br><span class="line">    <span class="built_in">std</span>::wcsrtombs(&amp;mbstr[<span class="number">0</span>], &amp;wstr, mbstr.size(), &amp;state);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"multibyte string: "</span> &lt;&lt; &amp;mbstr[<span class="number">0</span>] &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">              &lt;&lt; <span class="string">"Length, including '\\0': "</span> &lt;&lt; mbstr.size() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::setlocale(LC_ALL, <span class="string">"en_US.utf8"</span>);</span><br><span class="line">    <span class="comment">// UTF-8 narrow multibyte encoding</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">wchar_t</span>* wstr = <span class="string">L"z\u00df\u6c34\U0001d10b"</span>; <span class="comment">// or L"zÃŸæ°´ğ„‹"</span></span><br><span class="line">    print_wide(wstr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å­ä¸­çš„ <strong>std::setlocale(LC_ALL, â€œen_US.utf8â€);</strong> è°ƒç”¨æŒ‡æ˜äº†ç¼–ç æ–¹å¼ã€‚wchar_tç±»å‹æ•°ç»„ä¸­ï¼Œæ¯ä¸€ä¸ªå…ƒç´ å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œè€Œå½“ wchar_t* è½¬åŒ–ä¸º char* æ—¶ï¼Œä¸€ä¸ªwchar_tå­—ç¬¦å¯èƒ½éœ€è¦å¤šä¸ªcharå­—ç¬¦æ¥è¡¨ç¤ºï¼Œè¿™ç§è½¬æ¢å°±ä¾èµ–äºæˆ‘ä»¬è¿™é¡¶çš„å­—ç¬¦ç¼–ç è§„åˆ™ï¼Œè¿™é‡ŒæŒ‰ç…§utf8çš„ç¼–ç æ–¹å¼ï¼Œå°†ä¸€ä¸ªwchar_tå˜æˆå¤šä¸ªcharã€‚åä¹‹,å°†char*è½¬åŒ–ä¸ºwchar_t*æ—¶ï¼Œéœ€è¦çŸ¥é“char*çš„ç¼–ç æ–¹å¼ï¼Œè¿™é‡Œå°±æ˜¯utf8çš„ç¼–ç æ–¹å¼ï¼Œé‚£ä¹ˆè½¬æ¢å‡½æ•°æŒ‰ç…§utf8çš„è§„åˆ™ï¼Œå°†å¤šä¸ªcharç»„åˆèµ·æ¥ï¼Œå¾—åˆ°ä¸€ä¸ªUnicodeç¼–ç å€¼ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ªwchar_tä¸­ã€‚</p>
<h2 id="ç¼–ç è½¬æ¢">ç¼–ç è½¬æ¢</h2><p>ä¸€èˆ¬çš„ç¼–ç è½¬æ¢ï¼Œç›´æ¥æ˜ å°„ç›¸å¯¹è¾ƒéš¾ï¼Œéœ€è¦æ¯”è¾ƒå¤šçš„å·¥ä½œé‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹é€‰æ‹©Unicodeä½œä¸ºè½¬æ¢ä¸­ä»‹ã€‚</p>
<p>Linuxä¸Šçš„iconvé¡¹ç›®æ˜¯ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿç¬¬ä¸‰æ–¹åº“ï¼Œå…¶å®è´¨ä¹Ÿæ˜¯ä»¥Unicodeä½œä¸ºè½¬æ¢çš„ä¸­ä»‹ã€‚å…·ä½“å¯å‚é˜…<a href="http://www.gnu.org/software/libiconv/?cm_mc_uid=61509682042514188180227&amp;cm_mc_sid_50200000=1472309727" target="_blank" rel="external">iconvç›¸å…³ç½‘ç«™</a>ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://shijianguang.github.io/2016/08/27/C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦/" data-id="cisg8uybo0000dqs6ppbdjp84" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/C-C/">C/C++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Charset/">Charset</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-Tips-of-Java" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/15/Tips-of-Java/">Tips of Java</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2016/08/15/Tips-of-Java/">
      <time datetime="2016-08-15T07:38:50.000Z" itemprop="datePublished">2016-08-15</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Work/">Work</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <h2 id="1-_Collection_ç±»å‹">1. Collection ç±»å‹</h2><p>åœ¨Javaä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ <strong>Set</strong> å’Œ <strong>Set&lt;?&gt;</strong> è¿™ä¸¤ç§æ–¹å¼çš„åŒºåˆ«ï¼Œå‚è§å¦‚ä¸‹code:</p>
<pre><code><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(List <span class="built_in">list</span>, Object o)</span> </span>{
        <span class="built_in">list</span>.add(o);
}

<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{
        List&lt;String&gt; <span class="built_in">list</span> = <span class="keyword">new</span> ArrayList&lt;&gt;();
        add(<span class="built_in">list</span>, <span class="number">10</span>);
        System.out.println(<span class="built_in">list</span>.get(<span class="number">0</span>));
}
</code></pre><p>è¿™æ®µcodeåœ¨ç¼–è¯‘çš„æ—¶å€™ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†è¿è¡Œçš„æ—¶å€™ä¼šåœ¨ <code>list.get(0)</code> å¤„æŠ›å‡ºå¼‚å¸¸ï¼š</p>
<pre><code>Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java<span class="class">.lang</span><span class="class">.ClassCastException</span>: java<span class="class">.lang</span><span class="class">.Integer</span> cannot be cast to java<span class="class">.lang</span><span class="class">.String</span>
</code></pre><p>è¿™é‡Œä¸»è¦å› ä¸ºJavaçš„æ³›å‹æ˜¯é€šè¿‡ç¼–è¯‘æ—¶æœŸä¿éšœçš„ï¼Œå¦‚æœä½¿ç”¨åŸå§‹ç±»å‹ï¼Œå³åƒ <code>List</code> è¿™æ ·çš„ç±»å‹ï¼Œå°±è·³è¿‡äº†ç¼–è¯‘æ—¶çš„å‚æ•°æ£€æŸ¥ï¼Œæ‰€ä»¥è¿™ä¸ªç±»å‹çš„é”™è¯¯å°±è¢«æ¨è¿Ÿåˆ°äº†è¿è¡Œæ—¶æ‰ä½“ç°å‡ºæ¥ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ <strong>Set</strong> å’Œ <strong>Set&lt;?&gt;</strong> çš„åŒºåˆ«ã€‚<br>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ <strong>Set&lt;?&gt;</strong> çš„ä¸¤æ¡å‡†åˆ™ï¼š</p>
<ol>
<li>ç”±äºï¼Ÿæ˜¯é€šé…ç¬¦ï¼Œè¡¨ç¤ºä»»æ„ç±»å‹ï¼Œæ‰€ä»¥Set&lt;?&gt;å¯ä»¥ä¿å­˜ä»»ä½•ç±»å‹çš„æ•°æ®</li>
<li>ç”±äºæˆ‘ä»¬ä¸çŸ¥é“ï¼Ÿè¡¨ç¤ºä»€ä¹ˆç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½åƒSet&lt;?&gt;ä¸­æ·»åŠ å…ƒç´ </li>
</ol>
<p>è¿™ä¸¤å¥è¯çœ‹ä¼¼çŸ›ç›¾ï¼Œæˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªä¾‹å­åˆ†åˆ«è¯´æ˜ç¬¬ä¸€ç‚¹å’Œç¬¬äºŒç‚¹<br>é’ˆå¯¹ç¬¬ä¸€ç‚¹ï¼Œä»å¦‚ä¸‹çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨<strong>List&lt;?&gt;</strong>åšå‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†<strong>List<integer></integer></strong>å’Œ<strong>List<string></string></strong>ä¼ ç»™printå‡½æ•°ï¼ŒåŒäº‹printå‡½æ•°é‡Œé¢å¯ä»¥ä½¿ç”¨Objectè¿›è¡Œå¾ªç¯ï¼š</p>
<pre><code><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{
    List&lt;Integer&gt; l1 = <span class="keyword">new</span> ArrayList&lt;&gt;();
    printList(l1);

    List&lt;String&gt; l2 = <span class="keyword">new</span> ArrayList&lt;&gt;();
    printList(l2);
}

<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printSet</span><span class="params">(List&lt;?&gt; <span class="built_in">list</span>)</span> </span>{
    <span class="keyword">for</span>(Object ele : <span class="built_in">list</span>) {
        System.out.println(ele)
    }
}
</code></pre><p>é’ˆå¯¹ç¬¬äºŒç‚¹ï¼Œä»å¦‚ä¸‹çš„éæ³•codeç‰‡æ®µä¸­å¯ä»¥ç†è§£å®ƒï¼Œè¿™é‡Œ<strong>list.add(10)</strong>æ˜¯éæ³•çš„ï¼Œå› ä¸ºä»–æ˜¯<strong>List&lt;?&gt;</strong>ç±»å‹ï¼Œæ— æ³•ç¡®å®šæ³›å‹çš„ç±»å‹ï¼Œæ‰€ä»¥æ— æ³•æ·»åŠ å…ƒç´ åˆ°å…¶ä¸­:</p>
<pre><code><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printSet</span><span class="params">(List&lt;?&gt; <span class="built_in">list</span>)</span> </span>{
    <span class="built_in">list</span>.add(<span class="number">10</span>);
    <span class="keyword">for</span>(Object ele : <span class="built_in">list</span>) {
        System.out.println(ele)
    }
}
</code></pre><p>å¦‚æœä¸Šè¿°codeä¸­ï¼Œå°†ç±»å‹ä»<strong>List&lt;?&gt;</strong>æ¢ä¹˜<strong>List</strong>ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚ä½†å­˜åœ¨ç±»å‹ä¸å®‰å…¨çš„éšæ‚£ï¼Œå› ä¸º<strong>List</strong>ç±»å‹è·³è¿‡äº†ç±»å‹æ£€æŸ¥ã€‚</p>
<p>æ‰€ä»¥<strong>&lt;?&gt;</strong>åªèƒ½è¢«ç”¨åœ¨å‚æ•°ä¸­ï¼Œå½“ä½ ä¸å…³å¿ƒä¼ å…¥çš„æ³›å‹å…·ä½“æ˜¯ä»€ä¹ˆç±»å‹æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨<strong>&lt;?&gt;</strong></p>
<h2 id="2-_é™æ€å¸¸é‡åˆå§‹åŒ–é—®é¢˜">2. é™æ€å¸¸é‡åˆå§‹åŒ–é—®é¢˜</h2><p>æœ€è¿‘åœ¨å·¥ä½œä¸­é‡åˆ°äº†ä¸€ä¸ªå…³äºé™æ€åˆå§‹åŒ–çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥æŠ½è±¡æˆä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¥å±•ç¤ºé—®é¢˜çš„æ ¹æºï¼š</p>
<pre><code><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] argvs</span>) </span>{
    System.<span class="keyword">out</span>.println(StaticFinalInit.TEXT);
    System.<span class="keyword">out</span>.println(StaticInit.TEXT);

    StaticArrayInit[] array = <span class="keyword">new</span> StaticArrayInit[<span class="number">10</span>];
    System.<span class="keyword">out</span>.println(array.length);
}

<span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StaticFinalInit</span> {
    <span class="keyword">public</span> <span class="keyword">static</span> final String TEXT = <span class="string">"Hello"</span>;

    <span class="keyword">static</span> {
        System.<span class="keyword">out</span>.println(<span class="string">"Static Final Init"</span>);
    }
}

<span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StaticInit</span> {
    <span class="keyword">public</span> <span class="keyword">static</span> String TEXT = <span class="string">"Hello"</span>;

    <span class="keyword">static</span> {
        System.<span class="keyword">out</span>.println(<span class="string">"Static Init"</span>);
    }
}

<span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StaticArrayInit</span> {
    <span class="keyword">public</span> <span class="keyword">static</span> String TEXT = <span class="string">"Hello"</span>;

    <span class="keyword">static</span> {
        System.<span class="keyword">out</span>.println(<span class="string">"Static Array Init"</span>);
    }
}

<span class="keyword">static</span> <span class="keyword">class</span> <span class="title">NonRefStatic</span> {
    <span class="keyword">public</span> <span class="keyword">static</span> String TEXT = <span class="string">"Hello"</span>;

    <span class="keyword">static</span> {
        System.<span class="keyword">out</span>.println(<span class="string">"Non Ref Static Init"</span>);
    }
}

Output:
Hello
Static Init
Hello
<span class="number">10</span>
</code></pre><p>ä»ç»“æœä¸Šå¯ä»¥å‘ç°å¦‚ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>NonRefStaticè¿™ä¸ªç±»çš„é™æ€åˆå§‹åŒ–å‡½æ•°å¹¶æ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ•´ä¸ªä»£ç ä¸­å¹¶æ²¡æœ‰å¼•ç”¨åˆ°è¿™ä¸ªç±»ï¼Œæ‰€ä»¥è¿™ä¸ªç±»æ²¡æœ‰è¢«åŠ è½½ï¼Œè€Œé™æ€åˆå§‹åŒ–å‡½æ•°æ˜¯åœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ï¼Œæ‰€ä»¥NonRefStaticçš„é™æ€æ„é€ å‡½æ•°å¹¶æ²¡æœ‰è¢«è°ƒç”¨</li>
<li>StaticFinalInitè¿™ä¸ªç±»çš„é™æ€åˆå§‹åŒ–å‡½æ•°ä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸ºTEXTæ˜¯ä¸€ä¸ªå¸¸é‡å­—æ®µï¼Œç¼–è¯‘çš„æ—¶å€™è¿™ä¸ªå¸¸é‡ä¼šè¿›å…¥å¸¸é‡æ± ï¼Œè°ƒç”¨çš„æ—¶å€™ç›´æ¥è®¿é—®å¸¸é‡æ± ï¼Œå¹¶æ²¡æœ‰å¼•ç”¨å®šä¹‰å¸¸é‡çš„ç±»ï¼Œæ‰€ä»¥å®šä¹‰å¸¸é‡çš„ç±»ç›¸å½“äºæ²¡æœ‰è¢«åŠ è½½ï¼Œæ‰€ä»¥é™æ€æ„é€ å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨</li>
<li>Javaå®ä¾‹åŒ–æ•°ç»„æ˜¯ï¼Œå¹¶æ²¡æœ‰å®ä¾‹åŒ–æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œä¸ä¼šè§¦å‘è¿™ä¸ªç±»çš„å„ç§åˆå§‹åŒ–è¿‡ç¨‹</li>
</ol>
<p>åœ¨å·¥ä½œä¸­é‡åˆ°çš„é—®é¢˜ä¸ç¬¬äºŒç‚¹æ¯”è¾ƒç›¸åƒã€‚å·¥ç¨‹ä¸­å®šä¹‰äº†ä¸€ä¸ªConfigUtilç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€äº›ç³»ç»Ÿå‚æ•°ï¼Œå¹¶åŒæ—¶åœ¨resourceä¸­åŠ å…¥config.propertiesæ–‡ä»¶ï¼ŒConfigUtilç±»åœ¨é™æ€åˆå§‹åŒ–æ˜¯å»åŠ è½½è¿™ä¸ªresourceæ–‡ä»¶ï¼Œåœ¨config.propertiesæ–‡ä»¶ä¸­å°†é…ç½®é¡¹çš„åå­—å‘½åæˆä¸ConfigUtilç±»ä¸­çš„åå­—ä¸€æ ·ï¼Œè¿™æ ·é€šè¿‡åå°„è‡ªåŠ¨å°†ConfigUtilä¸­çš„ç³»ç»Ÿå‚æ•°å˜é‡çš„å€¼æ›¿æ¢ä¸ºæ–‡ä»¶ä¸­çš„å€¼ï¼Œå¹¶ä¸”æ–°å¢é…ç½®é¡¹åªè¦éµå®ˆè¿™ä¸ªè§„åˆ™ï¼Œåœ¨ä¸¤ä¸ªåœ°æ–¹å®šä¹‰åå­—ç›¸åŒï¼Œå°±å¯è‡ªåŠ¨åŠ è½½ã€‚ä½†æœŸåˆè¿™ä¸ªæ–¹æ³•å¹¶ä¸ç”Ÿæ•ˆï¼Œé…ç½®æ–‡ä»¶ä¸­çš„å–å€¼æ—¶å€™åŠ è½½ä¸åˆ°ConfigUtilç±»ä¸­ï¼Œæœ€åç»æ’æŸ¥ï¼Œé—®é¢˜ä¸ç¬¬äºŒç‚¹ç±»ä¼¼ï¼Œå› ä¸ºåœ¨ConfigUtilä¸­å°†å˜é‡ç”Ÿå‘½æˆäº†finalï¼Œå¹¶ä¸”ç»™äº†é»˜è®¤å€¼ï¼Œæ‰€ä»¥å½“ç¨‹åºè¯»å–ConfigUtilä¸­çš„å˜é‡æ—¶ï¼Œç›´æ¥è¯»å–å¸¸é‡æ± ï¼Œæ ¹æœ¬æ²¡æœ‰å‡ºå‘é™æ€åˆå§‹åŒ–</p>
<p>Javaä¸­çš„å„ç§åˆå§‹åŒ–è°ƒç”¨é¡ºåºï¼šé™æ€å˜é‡å®šä¹‰æ—¶çš„åˆå§‹åŒ–å€¼-&gt;é™æ€åˆå§‹åŒ–å¿«-&gt;æ™®é€šå˜é‡å®šä¹‰æ—¶çš„åˆå§‹åŒ–å€¼-&gt;åˆå§‹åŒ–å—-&gt;æ„é€ å‡½æ•°</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://shijianguang.github.io/2016/08/15/Tips-of-Java/" data-id="cisg8uycl0008dqs6ycyoon6l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-CSAPP-Optimizing-Program-Performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/08/16/CSAPP-Optimizing-Program-Performance/">Optimizing Program Performance</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/08/16/CSAPP-Optimizing-Program-Performance/">
      <time datetime="2015-08-16T05:54:40.000Z" itemprop="datePublished">2015-08-16</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Reading-Note/">Reading Note</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <h2 id="Preface">Preface</h2><p>The primary objective in writing a program is must be to make it work correctly under all possible conditions. A program that runs fast but gives incorrect results is useless. But on the other hand, making a program fast is also important. For a program which need to run one or two days, 20% faster than before is a significant improvement.</p>
<p>To write an efficient program require several types of activities:</p>
<ol>
<li>Select appropriate data structures and algorithms.</li>
<li>We must write source code that compiler can effectively optimize to turn into efficient executable code.</li>
<li>For modern multi-core CPU, divide a task into portions that can be computed in parallel</li>
</ol>
<p>For part 1, it depends on the problem you are facing to. Take sort for example, every on know heap sort is O(nlgn) and an insert sort is O(n^2), but if the size of the array which need to be sort is small, say 4 or 8, inert sort may be faster than heap sort because the constant of O()</p>
<p>For part 3, the most important thing is how to divide the task and how to decrease confliction. If you can divide the origin task into four part and they donâ€™t depend on each other during computing, you will get 4x speed on a 4 cores CPU.</p>
<p>This blog will focus on part 2. First we will discuss how to measure the speed or efficiency of a programm. Secondly, we will discuss the limitation of compiler. Then we will discuss two point of optimizing your program: eliminate unnecessary part of your program and leverage instrument parallel. At last, we will show some useful tools.</p>
<h2 id="Metrics_for_Program_Speed">Metrics for Program Speed</h2><p>Here, we introduce a metric named <strong>Cycles Per Element</strong>, abbreviate <strong>CPE</strong>. It means that how many CPU clock cycles one element need. It can help us understand loop performance of iterative program in a detailed level.</p>
<h2 id="Limitation_of_Compiler">Limitation of Compiler</h2><p>As you know, modern compilers employ sophisticated algorithms to do optimization for our program. For example, GCC provide -O1, -O2 and -O3 levels for user to select. One shortcoming of high level optimization is that it will make the program harder to debug for programmer and standard debugging tool.</p>
<p>Although compilers can do optimization for us, it has a rule that compilers must do <strong>safe optimizations</strong> to a program, meaning that the resulting program will have the exact same behavior as would an unoptimized version for all possible cases the program may encounter. Up to this safe optimization, we need to do more things to make compiler produce more efficient machine-level code. Let us see an example.</p>
<p>Look at the following code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">twiddle1</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *xp, <span class="keyword">volatile</span> <span class="keyword">int</span> *yp)</span> </span>&#123;</span><br><span class="line">    *xp += *yp;</span><br><span class="line">    *xp += *yp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">twiddle2</span><span class="params">(<span class="keyword">volatile</span> <span class="keyword">int</span> *xp, <span class="keyword">volatile</span> <span class="keyword">int</span> *yp)</span> </span>&#123;</span><br><span class="line">    *xp += <span class="number">2</span> * (*yp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>At first glance, both the two function do the same thing. But in my computer, function <em>twiddle1</em> takes 5777us for 1,000,000 times call and function <em>twiddle2</em> takes 3656us. Function <em>twiddle2</em> is almost <strong>40% faster</strong> than function <em>twiddle1</em>. The reason is that function <em>twiddle1</em> need six memory references and function <em>twiddle2</em> only need three. You may think why compiler not try to optimize function <em>twiddle1</em> to have three memory references as function <em>twiddle2</em> does. The reason is safe optimization rule. Consider if the address of xp and yp is equals, the two function will give different result. So even you know the function actually canâ€™t encounter the xp == yp situation, the compiler will not do the optimization. What you can do is use function <em>twiddle2</em> code instead of function <em>twiddle1</em>.</p>
<h2 id="Code_Example_and_environment">Code Example and environment</h2><p>My computer environment:<br>  CPU: 2.5GHz<br>  GCC Optimization Level: O1</p>
<p>Pre-define Code:<br>Here the code snippet pre-defines some structures and functions which will be use in the following parts.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span> <span class="keyword">data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">data_t</span> *data;</span><br><span class="line">&#125; vec_rec, *vec_ptr;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> IDENT <span class="number">0</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> OP +</span></span><br><span class="line"></span><br><span class="line"><span class="function">vec_ptr <span class="title">new_vec</span><span class="params">(<span class="keyword">long</span> <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    vec_ptr result = (vec_ptr) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(vec_rec));</span><br><span class="line">    <span class="keyword">if</span>(!result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    result-&gt;len = len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">data_t</span> * data = (<span class="keyword">data_t</span> *)<span class="built_in">calloc</span>(len, <span class="keyword">sizeof</span>(<span class="keyword">data_t</span>));</span><br><span class="line">        <span class="keyword">if</span>(!data) &#123;</span><br><span class="line">            <span class="built_in">free</span>((<span class="keyword">void</span> *) result);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result-&gt;data = data;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_vec_element</span><span class="params">(vec_ptr v, <span class="keyword">long</span> <span class="keyword">int</span> index, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt;= v-&gt;len)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    *dest = v-&gt;data[index];</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">int</span> <span class="title">vec_length</span><span class="params">(vec_ptr v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v-&gt;len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here is a first version of combine function, called <strong>combine1</strong>, we will optimize it step by step.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combine1</span><span class="params">(vec_ptr v, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    *dest = IDENT;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; vec_length(v) ; ++ i) &#123;</span><br><span class="line">        <span class="keyword">data_t</span> val;</span><br><span class="line">        get_vec_element(v, i, &amp;val);</span><br><span class="line">        *dest = *dest OP val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Eliminate_Unnecessary_Part">Eliminate Unnecessary Part</h2><h3 id="Tip_1:_Eliminate_inefficient_code_piece_in_loop">Tip 1: Eliminate inefficient code piece in loop</h3><p>From the <strong>combine1</strong> function, we can see that <strong>vec_length</strong> is the test condition of the FOR LOOP. This function will be invoked for each iteration of the loop. But actually, we will not change the length of the vector in the loop. We can get the length before the loop start and use it during the loop. Here is the second version of combine function, called <strong>combine2</strong>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combine2</span><span class="params">(vec_ptr v, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> length = vec_length(v);</span><br><span class="line"></span><br><span class="line">    *dest = IDENT;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; length ; ++ i) &#123;</span><br><span class="line">        <span class="keyword">data_t</span> val;</span><br><span class="line">        get_vec_element(v, i, &amp;val);</span><br><span class="line">        *dest = *dest OP val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In <strong>combine2</strong>, we first get the length and then begin the loop. For a 10,000,000 vector, <strong>combine1</strong> use 33734us and <strong>combine2</strong> use 21763us on my computer using O1 optimization for GCC. The <strong>CPE</strong> for <strong>combine1</strong> is 8.43 and <strong>combine2</strong> is 5.44.</p>
<h3 id="Tip_2:_Reduce_function_invokation">Tip 2: Reduce function invokation</h3><p>In <strong>combine2</strong> function, <strong>get_vec_element</strong> will be called once per iteration. In <strong>get_vec_element</strong> function, it will check the <strong>index</strong> param whether it is out of bound or not. Both the function call and the inner check is redundant. We can get the start address of the vector before the loop and access the vector data directly. Here is the third version of combine function, called <strong>combine3</strong>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data_t</span> *get_vec_start(vec_ptr v) &#123;</span><br><span class="line">    <span class="keyword">return</span> v-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combine3</span><span class="params">(vec_ptr v, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> length = vec_length(v);</span><br><span class="line">    <span class="keyword">data_t</span> *data = get_vec_start(v);</span><br><span class="line"></span><br><span class="line">    *dest = IDENT;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; length ; ++ i) &#123;</span><br><span class="line">        *dest = *dest OP data[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>When gcc use O1 level optimization on my computer, the lift is not obvious. When gcc use O0 level optimization, <strong>combine3</strong> has 50% performance lift comparing with <strong>combine2</strong>.</p>
<h3 id="Tip_3:_Eliminate_unnecessary_memory_reference">Tip 3: Eliminate unnecessary memory reference</h3><p>For each iteration in <strong>combine3</strong> function, it will load <strong>dest</strong>, do the operation and store the new value to <strong>dest</strong>. But we donâ€™t need access <strong>dest</strong> memory every time actually. What we need is just store the result to <strong>dest</strong> before we return from the function. Here is the forth version of combine function, called <strong>combine4</strong>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combine4</span><span class="params">(vec_ptr v, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> length = vec_length(v);</span><br><span class="line">    <span class="keyword">data_t</span> *data = get_vec_start(v);</span><br><span class="line">    <span class="keyword">data_t</span> acc = IDENT;</span><br><span class="line"></span><br><span class="line">    *dest = IDENT;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; length ; ++ i) &#123;</span><br><span class="line">        acc = acc OP data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    *dest = acc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>For a 10,000,000 vector on my computer, <strong>combine4</strong> use 4241us and the CPE is 1.06. The reason why performance lift so much is that we eliminate two unnecessary memory reference: read from <strong>dest</strong> and store to <strong>dest</strong>.<br>Here is the two inner loop ASM code:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LBB6_1:                                 ## %.lr.ph&#10;                                        ## =&#62;This Inner Loop Header: Depth=1&#10;&#9;movl&#9;(%rax), %ecx&#10;&#9;addl&#9;%ecx, (%r14)&#10;&#9;addq&#9;$4, %rax&#10;&#9;decq&#9;%rbx&#10;&#9;jne&#9;LBB6_1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LBB7_1:                                 ## %.lr.ph&#10;                                        ## =&#62;This Inner Loop Header: Depth=1&#10;&#9;addl&#9;(%rax), %ecx&#10;&#9;addq&#9;$4, %rax&#10;&#9;decq&#9;%rbx&#10;&#9;jne&#9;LBB7_1</span><br></pre></td></tr></table></figure>
<p>The first one is <strong>combine3</strong>â€˜s ASM code and the second is <strong>combine4</strong>â€˜s. You can see there is a movl instruction in the beginning of each iteration and addl instruction store the result to a memory address. These are the two unnecessary memory reference.</p>
<h1 id="Leverage_Instrument_Parallel">Leverage Instrument Parallel</h1><p>Modern CPU architecture has pipeline and superscalar which means it can emit more than one instruction in a CPU cycle. In <strong>combine4</strong>, however, next add instruction must wait the current instruction finish because they all depend on <strong>acc</strong> variable. The first add instruction must write the value to <strong>acc</strong>, then the second instruction can begin. So if we expend the loop and use multi variable to accumulate the result, we will leverage CPUâ€™s pipeline and superscalar features. Here is the fifth version of combine called <strong>combine5</strong>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">combine5</span><span class="params">(vec_ptr v, data_t *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> length = vec_length(v);</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">int</span> limit = length - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">data_t</span> *data = get_vec_start(v);</span><br><span class="line">    <span class="keyword">data_t</span> acc0 = IDENT;</span><br><span class="line">    <span class="keyword">data_t</span> acc1 = IDENT;</span><br><span class="line">    <span class="keyword">data_t</span> acc2 = IDENT;</span><br><span class="line">    <span class="keyword">data_t</span> acc3 = IDENT;</span><br><span class="line"></span><br><span class="line">    *dest = IDENT;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span> ; i &lt; limit ; i += <span class="number">4</span>) &#123;</span><br><span class="line">        acc0 = acc0 OP data[i];</span><br><span class="line">        acc1 = acc1 OP data[i + <span class="number">1</span>];</span><br><span class="line">        acc2 = acc2 OP data[i + <span class="number">2</span>];</span><br><span class="line">        acc3 = acc3 OP data[i + <span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>( ; i &lt; length ; ++ i) &#123;</span><br><span class="line">        acc0 = acc0 OP data[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *dest = acc0 OP acc1 OP acc2 OP acc3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>In <strong>combine5</strong>, we use four variables to do the accumulation. Besides the advantage of pipeline and superscalar, it also reduce the loop condition judgement time and loop index increase operation time. They both are not the major part of the combine function. For a 10,000,000 vector on my computer, <strong>combine5</strong> use 2898us and the CPE is 0.72.</p>
<p>Above it all test on <strong>int</strong> type addition, Here we also give a conclusion table for <strong>float</strong> type addition. You can see even using O2 level optimization, <strong>combine5</strong>â€˜s CPE is <strong>combine1</strong>â€˜s half.<br>Function | -O1 us | -O1 CPE | -O2 us | -O2 CPE<br>:â€”â€”â€”â€”â€”|:â€”â€”â€”â€”â€”|:â€”â€”â€”â€”â€”|:â€”â€”â€”â€”â€”|:â€”â€”â€”â€”â€”<br>combine1 | 34013 | 8.5 | 9136 | 2.28<br>combine5 | 6023 | 1.5 | 4508 | 1.12</p>
<h2 id="Useful_tool">Useful tool</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://shijianguang.github.io/2015/08/16/CSAPP-Optimizing-Program-Performance/" data-id="cisg8uycn000cdqs6iehpq1ee" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System-Programming/">System Programming</a></li></ul>

    </footer>
  </div>
  
</article>



    </section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">recents</h3>
    <div class="widget">
      <ul id="recent-post" class="">
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2016/08/28/C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"></p>
              <p class="item-title"><a href="/2016/08/28/C-å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰/" class="title">C++ å³å€¼å¼•ç”¨å’Œè½¬ç§»è¯­ä¹‰</a></p>
              <p class="item-date"><time datetime="2016-08-28T04:13:02.000Z" itemprop="datePublished">2016-08-28</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2016/08/27/C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Work/">Work</a></p>
              <p class="item-title"><a href="/2016/08/27/C-wchar-t-è¡¨ç¤ºä¸­æ–‡å­—ç¬¦/" class="title">C++ wchar_t è¡¨ç¤ºä¸­æ–‡å­—ç¬¦</a></p>
              <p class="item-date"><time datetime="2016-08-27T12:32:36.000Z" itemprop="datePublished">2016-08-27</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2016/08/15/Tips-of-Java/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Work/">Work</a></p>
              <p class="item-title"><a href="/2016/08/15/Tips-of-Java/" class="title">Tips of Java</a></p>
              <p class="item-date"><time datetime="2016-08-15T07:38:50.000Z" itemprop="datePublished">2016-08-15</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-thumbnail">
              <a href="/2015/08/16/CSAPP-Optimizing-Program-Performance/" class="thumbnail">
  
    <span class="thumbnail-image thumbnail-none"></span>
  
</a>
            </div>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Reading-Note/">Reading Note</a></p>
              <p class="item-title"><a href="/2015/08/16/CSAPP-Optimizing-Program-Performance/" class="title">Optimizing Program Performance</a></p>
              <p class="item-date"><time datetime="2015-08-16T05:54:40.000Z" itemprop="datePublished">2015-08-16</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Reading-Note/">Reading Note</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Work/">Work</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-C/">C/C++</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Charset/">Charset</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/System-Programming/">System Programming</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">tag cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C-C/" style="font-size: 20px;">C/C++</a> <a href="/tags/Charset/" style="font-size: 10px;">Charset</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/System-Programming/" style="font-size: 10px;">System Programming</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 - 2016 Jianguang Shi<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    


<script src="//ajax.useso.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>